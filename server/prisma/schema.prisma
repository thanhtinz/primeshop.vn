generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============ USER & AUTH ============

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  password              String?   // null for OAuth users
  displayName           String?   @map("display_name")
  avatarUrl             String?   @map("avatar_url")
  phone                 String?
  bio                   String?   @db.Text
  balance               Decimal   @default(0) @db.Decimal(12, 2)
  points                Int       @default(0)
  level                 Int       @default(1)
  isPrime               Boolean   @default(false) @map("is_prime")
  primeExpiresAt        DateTime? @map("prime_expires_at")
  isVerified            Boolean   @default(false) @map("is_verified")
  isBanned              Boolean   @default(false) @map("is_banned")
  banReason             String?   @map("ban_reason")
  lastLoginAt           DateTime? @map("last_login_at")
  emailVerifiedAt       DateTime? @map("email_verified_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  // Relations
  profile               UserProfile?
  oauthAccounts         OAuthAccount[]
  refreshTokens         RefreshToken[]
  orders                Order[]
  payments              Payment[]
  deposits              Deposit[]
  notifications         Notification[]
  posts                 Post[]
  comments              Comment[]
  reviews               Review[]
  cartItems             CartItem[]
  wishlistItems         WishlistItem[]
  addresses             Address[]
  
  @@map("users")
}

model UserProfile {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  coverUrl          String?  @map("cover_url")
  website           String?
  location          String?
  birthday          DateTime?
  gender            String?
  socialLinks       Json?    @map("social_links")
  settings          Json?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_profiles")
}

// Email notification preferences per user
model UserEmailPreferences {
  id                      String   @id @default(uuid())
  userId                  String   @unique @map("user_id")
  
  // Master toggle - disable all emails
  emailEnabled            Boolean  @default(true) @map("email_enabled")
  
  // Authentication & Security
  authEmails              Boolean  @default(true) @map("auth_emails")          // login, password, 2FA
  securityAlerts          Boolean  @default(true) @map("security_alerts")      // suspicious activity
  
  // Orders & Transactions
  orderEmails             Boolean  @default(true) @map("order_emails")         // order confirmation, status updates
  paymentEmails           Boolean  @default(true) @map("payment_emails")       // payment success/failed, deposits
  invoiceEmails           Boolean  @default(true) @map("invoice_emails")       // invoices, statements
  
  // Promotions & Marketing
  promotionEmails         Boolean  @default(true) @map("promotion_emails")     // flash sales, new products
  voucherEmails           Boolean  @default(true) @map("voucher_emails")       // voucher gifts, expiring
  newsletterEmails        Boolean  @default(false) @map("newsletter_emails")   // weekly digest, system updates
  
  // Social & Community
  socialEmails            Boolean  @default(true) @map("social_emails")        // followers, comments, reviews
  messageEmails           Boolean  @default(true) @map("message_emails")       // chat messages, tickets
  
  // Gamification
  rewardEmails            Boolean  @default(true) @map("reward_emails")        // points, achievements, level up
  checkinEmails           Boolean  @default(false) @map("checkin_emails")      // daily checkin reminders
  
  // Auctions & Groups
  auctionEmails           Boolean  @default(true) @map("auction_emails")       // bids, outbid, won/lost
  groupOrderEmails        Boolean  @default(true) @map("group_order_emails")   // group invitations, success/failed
  
  // Wishlist & Cart
  wishlistEmails          Boolean  @default(true) @map("wishlist_emails")      // price drops, back in stock
  cartReminderEmails      Boolean  @default(true) @map("cart_reminder_emails") // abandoned cart
  
  // Prime & VIP
  primeEmails             Boolean  @default(true) @map("prime_emails")         // prime activation, expiring
  vipEmails               Boolean  @default(true) @map("vip_emails")           // level up, benefits
  
  // Seller (for sellers)
  sellerEmails            Boolean  @default(true) @map("seller_emails")        // new sales, daily reports
  
  // Affiliate
  affiliateEmails         Boolean  @default(true) @map("affiliate_emails")     // commissions, tier upgrades
  
  // Events
  eventEmails             Boolean  @default(true) @map("event_emails")         // invitations, reminders
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@map("user_email_preferences")
}

model OAuthAccount {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  provider          String   // google, discord, facebook
  providerUserId    String   @map("provider_user_id")
  accessToken       String?  @map("access_token") @db.Text
  refreshToken      String?  @map("refresh_token") @db.Text
  expiresAt         DateTime? @map("expires_at")
  createdAt         DateTime @default(now()) @map("created_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerUserId])
  @@map("oauth_accounts")
}

model RefreshToken {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  token             String   @unique @db.VarChar(500)
  expiresAt         DateTime @map("expires_at")
  createdAt         DateTime @default(now()) @map("created_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("refresh_tokens")
}

model AdminUser {
  id                String   @id @default(uuid())
  username          String   @unique
  email             String   @unique
  passwordHash      String   @map("password_hash")
  role              String   @default("admin") // admin, super_admin
  isActive          Boolean  @default(true) @map("is_active")
  permissions       Json?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("admin_users")
}

// ============ PRODUCTS & CATEGORIES ============

model Category {
  id                String    @id @default(uuid())
  name              String
  nameEn            String?   @map("name_en")
  slug              String    @unique
  description       String?   @db.Text
  descriptionEn     String?   @map("description_en") @db.Text
  imageUrl          String?   @map("image_url")
  iconName          String?   @map("icon_name")
  style             String    @default("premium") // premium, game_topup, game_account, design
  isActive          Boolean   @default(true) @map("is_active")
  sortOrder         Int       @default(0) @map("sort_order")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  products          Product[]
  
  @@map("categories")
}

model Product {
  id                String    @id @default(uuid())
  categoryId        String?   @map("category_id")
  name              String
  nameEn            String?   @map("name_en")
  slug              String    @unique
  description       String?   @db.Text
  descriptionEn     String?   @map("description_en") @db.Text
  shortDescription  String?   @map("short_description")
  imageUrl          String?   @map("image_url")
  productStyle      String    @default("default") @map("product_style") // default, game_topup, game_account, subscription
  isActive          Boolean   @default(true) @map("is_active")
  isFeatured        Boolean   @default(false) @map("is_featured")
  sortOrder         Int       @default(0) @map("sort_order")
  viewCount         Int       @default(0) @map("view_count")
  soldCount         Int       @default(0) @map("sold_count")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  category          Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  packages          ProductPackage[]
  customFields      ProductCustomField[]
  images            ProductImage[]
  reviews           Review[]
  cartItems         CartItem[]
  wishlistItems     WishlistItem[]
  
  @@map("products")
}

model ProductPackage {
  id                String    @id @default(uuid())
  productId         String    @map("product_id")
  name              String
  description       String?
  price             Decimal   @db.Decimal(12, 2)
  originalPrice     Decimal?  @map("original_price") @db.Decimal(12, 2)
  imageUrl          String?   @map("image_url")
  isActive          Boolean   @default(true) @map("is_active")
  isInStock         Boolean   @default(true) @map("is_in_stock")
  sortOrder         Int       @default(0) @map("sort_order")
  externalProductId String?   @map("external_product_id") // For game topup APIs
  markupPercent     Decimal?  @map("markup_percent") @db.Decimal(5, 2) // Markup % for auto-pricing from source
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems        OrderItem[]
  
  @@map("product_packages")
}

model ProductCustomField {
  id                String   @id @default(uuid())
  productId         String   @map("product_id")
  fieldName         String   @map("field_name")
  fieldType         String   @default("text") @map("field_type")
  isRequired        Boolean  @default(false) @map("is_required")
  placeholder       String?
  options           Json?    // For select/radio types
  sortOrder         Int      @default(0) @map("sort_order")
  createdAt         DateTime @default(now()) @map("created_at")
  
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@map("product_custom_fields")
}

model ProductImage {
  id                String   @id @default(uuid())
  productId         String   @map("product_id")
  imageUrl          String   @map("image_url")
  altText           String?  @map("alt_text")
  isPrimary         Boolean  @default(false) @map("is_primary")
  sortOrder         Int      @default(0) @map("sort_order")
  createdAt         DateTime @default(now()) @map("created_at")
  
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@map("product_images")
}

// ============ ORDERS & PAYMENTS ============

model Order {
  id                String    @id @default(uuid())
  orderNumber       String    @unique @map("order_number")
  userId            String?   @map("user_id")
  customerEmail     String    @map("customer_email")
  customerName      String?   @map("customer_name")
  customerPhone     String?   @map("customer_phone")
  status            String    @default("PENDING_PAYMENT")
  subtotal          Decimal   @db.Decimal(12, 2)
  discountAmount    Decimal   @default(0) @map("discount_amount") @db.Decimal(12, 2)
  totalAmount       Decimal   @map("total_amount") @db.Decimal(12, 2)
  voucherId         String?   @map("voucher_id")
  voucherCode       String?   @map("voucher_code")
  referralCode      String?   @map("referral_code")
  deliveryContent   String?   @map("delivery_content") @db.Text
  notes             String?   @db.Text
  productSnapshot   Json      @map("product_snapshot")
  paidAt            DateTime? @map("paid_at")
  completedAt       DateTime? @map("completed_at")
  cancelledAt       DateTime? @map("cancelled_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  user              User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  voucher           Voucher?  @relation(fields: [voucherId], references: [id], onDelete: SetNull)
  items             OrderItem[]
  payments          Payment[]
  
  @@map("orders")
}

model OrderItem {
  id                String   @id @default(uuid())
  orderId           String   @map("order_id")
  packageId         String   @map("package_id")
  productName       String   @map("product_name")
  packageName       String   @map("package_name")
  quantity          Int      @default(1)
  unitPrice         Decimal  @map("unit_price") @db.Decimal(12, 2)
  totalPrice        Decimal  @map("total_price") @db.Decimal(12, 2)
  customFieldData   Json?    @map("custom_field_data")
  createdAt         DateTime @default(now()) @map("created_at")
  
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  package           ProductPackage @relation(fields: [packageId], references: [id])
  
  @@map("order_items")
}

model Payment {
  id                String   @id @default(uuid())
  orderId           String?  @map("order_id")
  userId            String?  @map("user_id")
  paymentProvider   String   @default("payos") @map("payment_provider")
  paymentType       String   @default("order") @map("payment_type") // order, deposit
  externalPaymentId String?  @map("external_payment_id")
  amount            Decimal  @db.Decimal(12, 2)
  currency          String   @default("VND")
  status            String   @default("pending")
  paymentUrl        String?  @map("payment_url") @db.Text
  checkoutUrl       String?  @map("checkout_url") @db.Text
  paymentData       Json?    @map("payment_data")
  paidAt            DateTime? @map("paid_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  order             Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@map("payments")
}

model Deposit {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  amount            Decimal  @db.Decimal(12, 2)
  bonusAmount       Decimal  @default(0) @map("bonus_amount") @db.Decimal(12, 2)
  totalAmount       Decimal  @map("total_amount") @db.Decimal(12, 2)
  paymentProvider   String   @default("payos") @map("payment_provider")
  externalPaymentId String?  @map("external_payment_id")
  status            String   @default("pending")
  paymentUrl        String?  @map("payment_url") @db.Text
  paidAt            DateTime? @map("paid_at")
  createdAt         DateTime @default(now()) @map("created_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("deposits")
}

// ============ VOUCHERS ============

model Voucher {
  id                String    @id @default(uuid())
  code              String    @unique
  discountType      String    @map("discount_type") // percentage, fixed
  discountValue     Decimal   @map("discount_value") @db.Decimal(12, 2)
  minOrderValue     Decimal?  @map("min_order_value") @db.Decimal(12, 2)
  maxDiscount       Decimal?  @map("max_discount") @db.Decimal(12, 2)
  usageLimit        Int?      @map("usage_limit")
  usedCount         Int       @default(0) @map("used_count")
  isActive          Boolean   @default(true) @map("is_active")
  isPrime           Boolean   @default(false) @map("is_prime")
  expiresAt         DateTime? @map("expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  orders            Order[]
  
  @@map("vouchers")
}

// ============ REVIEWS ============

model Review {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  productId         String   @map("product_id")
  orderId           String?  @map("order_id")
  rating            Int
  comment           String?  @db.Text
  images            Json?
  isVerified        Boolean  @default(false) @map("is_verified")
  isHidden          Boolean  @default(false) @map("is_hidden")
  adminReply        String?  @map("admin_reply") @db.Text
  helpfulCount      Int      @default(0) @map("helpful_count")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([userId, productId, orderId])
  @@map("reviews")
}

// ============ CART & WISHLIST ============

model CartItem {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  productId         String   @map("product_id")
  packageId         String?  @map("package_id")
  quantity          Int      @default(1)
  customFieldData   Json?    @map("custom_field_data")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([userId, productId, packageId])
  @@map("cart_items")
}

model WishlistItem {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  productId         String   @map("product_id")
  createdAt         DateTime @default(now()) @map("created_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([userId, productId])
  @@map("wishlist_items")
}

// ============ NOTIFICATIONS ============

model Notification {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  type              String
  title             String
  message           String   @db.Text
  data              Json?
  isRead            Boolean  @default(false) @map("is_read")
  readAt            DateTime? @map("read_at")
  createdAt         DateTime @default(now()) @map("created_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isRead])
  @@map("notifications")
}

// ============ SOCIAL (POSTS/COMMENTS) ============

model Post {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  content           String   @db.Text
  images            Json?
  visibility        String   @default("public")
  likeCount         Int      @default(0) @map("like_count")
  commentCount      Int      @default(0) @map("comment_count")
  shareCount        Int      @default(0) @map("share_count")
  isHidden          Boolean  @default(false) @map("is_hidden")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments          Comment[]
  likes             PostLike[]
  
  @@map("posts")
}

model Comment {
  id                String   @id @default(uuid())
  postId            String   @map("post_id")
  userId            String   @map("user_id")
  parentId          String?  @map("parent_id")
  content           String   @db.Text
  likeCount         Int      @default(0) @map("like_count")
  isHidden          Boolean  @default(false) @map("is_hidden")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  post              Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent            Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies           Comment[] @relation("CommentReplies")
  
  @@map("comments")
}

model PostLike {
  id                String   @id @default(uuid())
  postId            String   @map("post_id")
  userId            String   @map("user_id")
  createdAt         DateTime @default(now()) @map("created_at")
  
  post              Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@unique([postId, userId])
  @@map("post_likes")
}

// ============ ADDRESS ============

model Address {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  name              String
  phone             String
  addressLine       String   @map("address_line")
  ward              String?
  district          String?
  city              String?
  country           String   @default("Vietnam")
  isDefault         Boolean  @default(false) @map("is_default")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("addresses")
}

// ============ SITE SETTINGS ============

model SiteSetting {
  id                String   @id @default(uuid())
  key               String   @unique
  value             Json
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("site_settings")
}

// ============ VIP LEVELS ============

model VipLevel {
  id                String   @id @default(uuid())
  name              String
  minSpending       Decimal  @default(0) @map("min_spending") @db.Decimal(12, 2)
  discountPercent   Decimal  @default(0) @map("discount_percent") @db.Decimal(5, 2)
  benefits          Json?
  sortOrder         Int      @default(0) @map("sort_order")
  createdAt         DateTime @default(now()) @map("created_at")
  
  @@map("vip_levels")
}

// ============ LOGIN HISTORY ============

model LoginHistory {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  ipAddress         String?  @map("ip_address")
  userAgent         String?  @map("user_agent") @db.Text
  deviceType        String?  @map("device_type")
  browser           String?
  os                String?
  createdAt         DateTime @default(now()) @map("created_at")
  
  @@map("login_history")
}

// ============ SITE THEME ============

model SiteTheme {
  id                String   @id @default(uuid())
  isActive          Boolean  @default(true) @map("is_active")
  
  // Colors
  primaryColor      String   @default("#3B82F6") @map("primary_color")
  secondaryColor    String   @default("#10B981") @map("secondary_color")
  accentColor       String   @default("#8B5CF6") @map("accent_color")
  backgroundColor   String   @default("#FFFFFF") @map("background_color")
  textColor         String   @default("#111827") @map("text_color")
  linkColor         String   @default("#2563EB") @map("link_color")
  headerBgColor     String   @default("#FFFFFF") @map("header_bg_color")
  footerBgColor     String   @default("#1F2937") @map("footer_bg_color")
  footerTextColor   String   @default("#F9FAFB") @map("footer_text_color")
  
  // Typography
  fontFamily        String   @default("Inter") @map("font_family")
  headingFont       String   @default("Inter") @map("heading_font")
  fontSize          String   @default("16px") @map("font_size")
  
  // Layout
  layoutStyle       String   @default("default") @map("layout_style") // default, boxed, wide
  headerStyle       String   @default("default") @map("header_style") // default, sticky, transparent
  navbarPosition    String   @default("top") @map("navbar_position") // top, side
  sidebarStyle      String   @default("default") @map("sidebar_style") // default, compact, hidden
  borderRadius      String   @default("8px") @map("border_radius")
  
  // Custom CSS
  customCss         String?  @map("custom_css") @db.Text
  customHeadCode    String?  @map("custom_head_code") @db.Text
  customFooterCode  String?  @map("custom_footer_code") @db.Text
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("site_themes")
}

// ============ SITE SECTIONS ============

model SiteSection {
  id                String   @id @default(uuid())
  sectionKey        String   @unique @map("section_key") // hero, featured_products, categories, flash_sales, etc.
  sectionName       String   @map("section_name")
  isEnabled         Boolean  @default(true) @map("is_enabled")
  sortOrder         Int      @default(0) @map("sort_order")
  settings          Json?    // Section-specific settings
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("site_sections")
}

// ============ EMAIL ============

model EmailTemplate {
  id                String   @id @default(uuid())
  name              String   // Template name (e.g., 'welcome', 'order_confirmation')
  language          String   @default("vi") // Language code (vi, en)
  subject           String   @db.Text // Email subject
  html_content      String   @db.Text @map("body") // HTML body content
  text_content      String?  @db.Text // Plain text version
  variables         Json?    // Available variables for this template
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@unique([name, language])
  @@map("email_templates")
}

model EmailLog {
  id                String   @id @default(uuid())
  template          String?  @map("template_name") // Template name used
  recipient         String   // Email recipient
  subject           String   // Email subject
  status            String   @default("sent") // sent, failed, pending
  message_id        String?  @map("message_id") // SMTP message ID
  error             String?  @map("error_message") @db.Text // Error message if failed
  createdAt         DateTime @default(now()) @map("created_at")
  
  @@index([recipient])
  @@index([template])
  @@index([status])
  @@map("email_logs")
}

// ============ AUDIT LOG ============

model AuditLog {
  id                String   @id @default(uuid())
  userId            String?  @map("user_id")
  action            String
  tableName         String   @map("table_name")
  recordId          String?  @map("record_id")
  oldData           Json?    @map("old_data")
  newData           Json?    @map("new_data")
  ipAddress         String?  @map("ip_address")
  userAgent         String?  @map("user_agent") @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  
  @@map("audit_logs")
}

// ============ WALLET & TRANSACTIONS ============

model WalletTransaction {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  amount            Decimal  @db.Decimal(12, 2)
  type              String   // payment, deposit, refund, admin_credit, admin_debit, smm_order, auction_buy_now
  referenceType     String?  @map("reference_type") // order, deposit, seller_order, smm_order, auction
  referenceId       String?  @map("reference_id")
  note              String?  @db.Text
  status            String   @default("completed")
  createdAt         DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@map("wallet_transactions")
}

// ============ SMM ORDERS ============

model SmmOrder {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  serviceId         String   @map("service_id")
  link              String   @db.Text
  quantity          Int
  charge            Decimal  @db.Decimal(12, 2)
  externalOrderId   String?  @map("external_order_id")
  status            String   @default("pending") // pending, processing, completed, partial, refunded, cancelled
  startCount        Int?     @map("start_count")
  remains           Int?
  adminNote         String?  @map("admin_note") @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@index([userId])
  @@map("smm_orders")
}

// ============ SELLER ORDERS & ESCROW ============

model SellerOrder {
  id                String    @id @default(uuid())
  buyerId           String    @map("buyer_id")
  sellerId          String    @map("seller_id")
  productId         String?   @map("product_id")
  amount            Decimal   @db.Decimal(12, 2)
  platformFee       Decimal   @default(0) @map("platform_fee") @db.Decimal(12, 2)
  netAmount         Decimal   @map("net_amount") @db.Decimal(12, 2)
  status            String    @default("pending") // pending, delivered, completed, cancelled, disputed
  deliveryContent   String?   @map("delivery_content") @db.Text
  autoConfirmAt     DateTime? @map("auto_confirm_at")
  deliveredAt       DateTime? @map("delivered_at")
  completedAt       DateTime? @map("completed_at")
  cancelledAt       DateTime? @map("cancelled_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  escrow            EscrowTransaction?
  handoverLogs      HandoverLog[]
  
  @@index([buyerId])
  @@index([sellerId])
  @@map("seller_orders")
}

model EscrowTransaction {
  id                String   @id @default(uuid())
  orderId           String   @unique @map("order_id")
  buyerId           String   @map("buyer_id")
  sellerId          String   @map("seller_id")
  amount            Decimal  @db.Decimal(12, 2)
  status            String   @default("held") // held, released, refunded
  releasedAt        DateTime? @map("released_at")
  createdAt         DateTime @default(now()) @map("created_at")
  
  order             SellerOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("escrow_transactions")
}

model HandoverLog {
  id                String   @id @default(uuid())
  orderId           String   @map("order_id")
  actionType        String   @map("action_type") // submit_credentials, verify_login, change_password, confirm_delivery
  performedBy       String   @map("performed_by")
  details           Json?
  createdAt         DateTime @default(now()) @map("created_at")
  
  order             SellerOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("handover_logs")
}

// ============ AUCTIONS ============

model Auction {
  id                String    @id @default(uuid())
  sellerId          String?   @map("seller_id")
  title             String
  description       String?   @db.Text
  imageUrl          String?   @map("image_url")
  startingBid       Decimal   @map("starting_bid") @db.Decimal(12, 2)
  currentBid        Decimal   @default(0) @map("current_bid") @db.Decimal(12, 2)
  currentBidderId   String?   @map("current_bidder_id")
  buyNowPrice       Decimal?  @map("buy_now_price") @db.Decimal(12, 2)
  bidCount          Int       @default(0) @map("bid_count")
  status            String    @default("active") // active, completed, cancelled
  winnerId          String?   @map("winner_id")
  finalPrice        Decimal?  @map("final_price") @db.Decimal(12, 2)
  startTime         DateTime  @default(now()) @map("start_time")
  endTime           DateTime  @map("end_time")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  bids              AuctionBid[]
  
  @@map("auctions")
}

model AuctionBid {
  id                String   @id @default(uuid())
  auctionId         String   @map("auction_id")
  userId            String   @map("user_id")
  amount            Decimal  @db.Decimal(12, 2)
  createdAt         DateTime @default(now()) @map("created_at")
  
  auction           Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  
  @@index([auctionId])
  @@map("auction_bids")
}

// ============ DAILY CHECKIN & POINTS ============

model DailyCheckin {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  checkinDate       DateTime @map("checkin_date")
  streakCount       Int      @default(1) @map("streak_count")
  pointsEarned      Int      @default(0) @map("points_earned")
  createdAt         DateTime @default(now()) @map("created_at")
  
  @@index([userId, checkinDate])
  @@map("daily_checkins")
}

model PointsReward {
  id                String   @id @default(uuid())
  name              String
  description       String?  @db.Text
  pointsCost        Int      @map("points_cost")
  rewardType        String   @map("reward_type") // balance, voucher, item
  rewardValue       Decimal  @map("reward_value") @db.Decimal(12, 2)
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  
  redemptions       PointsRedemption[]
  
  @@map("points_rewards")
}

model PointsRedemption {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  rewardId          String   @map("reward_id")
  pointsSpent       Int      @map("points_spent")
  status            String   @default("completed")
  createdAt         DateTime @default(now()) @map("created_at")
  
  reward            PointsReward @relation(fields: [rewardId], references: [id])
  
  @@map("points_redemptions")
}

// ============ AFFILIATE ============

model AffiliateCode {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  code              String   @unique
  totalClicks       Int      @default(0) @map("total_clicks")
  totalConversions  Int      @default(0) @map("total_conversions")
  totalCommission   Decimal  @default(0) @map("total_commission") @db.Decimal(12, 2)
  createdAt         DateTime @default(now()) @map("created_at")
  
  clicks            AffiliateClick[]
  
  @@map("affiliate_codes")
}

model AffiliateClick {
  id                String   @id @default(uuid())
  affiliateCodeId   String   @map("affiliate_code_id")
  referrerUrl       String?  @map("referrer_url") @db.Text
  ipAddress         String?  @map("ip_address")
  createdAt         DateTime @default(now()) @map("created_at")
  
  affiliateCode     AffiliateCode @relation(fields: [affiliateCodeId], references: [id], onDelete: Cascade)
  
  @@map("affiliate_clicks")
}

// ============ DESIGN ORDERS ============

model DesignOrder {
  id                String    @id @default(uuid())
  buyerId           String?   @map("buyer_id")
  sellerId          String?   @map("seller_id")
  title             String
  description       String?   @db.Text
  requirements      Json?
  price             Decimal   @db.Decimal(12, 2)
  status            String    @default("pending") // pending, in_progress, delivered, completed, disputed, refunded, resolved
  deliveryFiles     Json?     @map("delivery_files")
  adminNote         String?   @map("admin_note") @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  @@index([buyerId])
  @@index([sellerId])
  @@map("design_orders")
}
